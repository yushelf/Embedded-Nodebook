# 对操作系统的理解

操作系统有三大主题元素，分别是虚拟化，并发和持久性。

虚拟化是指CPU虚拟化，内存虚拟化，操作系统通过调度、虚拟内存管理实现这两个功能。这两个虚拟化完成之后相当于在各个程序和硬件之间构建好了软件层，提供了一个抽象。

并发就是解决多线程多进程的问题，使得多个程序在宏观上能看起来同时执行。

那么持久性则是需要硬件和软件来持久性地存储数据。

实现了前面说到地三个主题元素，那么操作系统做什么的概念就出来了，操作系统取得CPU、内存或磁盘等物理资源，并对他们虚拟化。它处理与并发有关的麻烦且棘手的问题。它持久地存储文件，从而使他们长期安全。



## 一、虚拟内存

虚拟内存优点：

（1）扩大地址空间。每个进程独占一个4G空间，虽然真实物理内存没那么多。

（2）内存保护：防止不同进程对物理内存的争夺和践踏，可以对特定内存地址提供写保护，防止恶意篡改。

（3）可以避免内存碎片，虽然物理内存可能不连续，但映射到虚拟内存上可以连续。

### 分段

**每个程序存储在磁盘上，被分成特定的段,如代码段，堆，栈，加载至内存中，程序中的地址为偏移量，当运行时被重定位，也就是加上基地址。重定位过程：每个段都有一个基地址记录在程序的“PCB（控制块）”中。基地址根据查段表得到（此表名为LDT），也叫寄存器（内存映射表，段表），每个进程都有自己的LDT，由硬件操作查询。每次进程进程切换，表中的基地址也会被更改。**

在地址转换的基础上，再增加硬件支持，将程序每个段分开存入物理内存，这样就能避免内部碎片，提高内存的适用。具体做法就是，加入寄存器，可以通过地址的前两位来当标志位，显式地说明要引用的段，任然保持基址和界限寄存器，针对不同的段寄存器则不同。

### 分页

**在操作系统初始化的时候，把物理内存分成一页一页的，每一页都有记录是否被使用，如每4K一页；同时程序的每个段也被等分成页，换算成多少页，不足时取整。将页存入内存。**

相应的，把物理内存看成定长槽块的阵列，叫做页帧。

>分页比较灵活，操作系统能够高效地提供地址空间的抽象。
>
>分页提供的空闲空间管理具有简单性。

分页比较慢，需要许多额外的内存访问来访问页表，分页也会造成内存浪费，内存被页表塞满而不是有用的应用数据程序，**引入“快速地址转换”和“较小的表”**可解决这两个问题。

### 段页结合

段页结合才是操作系统的内存管理，完美的实现虚拟内存。面向程序员，需要提供段的方式，即代码是分段且连续的，面向底层硬件，需要使用页的方式进行存储。

首先用户程序中的物理地址访问，即**地址重定位：**在段表中得到虚拟地址，虚拟地址再放入页表中映射真实地物理地址。



**代码实现：**

 **1.分配虚存建段表**

 **2.分配内存建立页表**

 **3.使用内存**

**当读的时候父子进程共用内存，但是一旦一个开始写，则会为它分配新的内存，即新申请一个内存页，修改页表重新进行地址映射，MMU重新寻址，这样便能实现多进程的不冲突，地址分离，让影响相互独立，也就是常说的写时复制**



#### 快速地址转换



### 多级页表



### 内存换入与换出





## 二、锁





## 三、条件变量





## 四、信号量



